<!DOCTYPE html>
<head>
  <title>CS Force Graph</title>
  <meta charset="utf-8"/>
  <link rel="stylesheet" type="text/css" href="styles.css"/>
</head>
<body>
  <div id="header">
    <h1>CS Force Graph</h1>
    <h2>a graph of class requisites in UCLA's CS major</h2>
    <hr>
    <p id="info">A force directed graph implemented using 
      <a href="https://github.com/mbostock/d3/wiki/Force-Layout">Force Layout</a>
     from <a href="http://d3js.org/">d3.js</a>.<br><br>
      Classes are represented by nodes. When one node points to another, the class represented by that node
      is the prerequisite of the other class.</p>
  </div>
  <div id="legend">
    <h3>Legend</h3>
    <h4>Nodes:</h4>
    <ul style="margin-bottom: 6px">
      <li style="color: #ace">
        <label><input type="checkbox" checked value="lowerdiv" onclick="updateForce();">
          Lower Div CS Courses
        </label>
      </li>
      <li style="color: #17b">
        <label><input type="checkbox" checked value="upperdiv" onclick="updateForce();">
          Upper Div CS Requirements
        </label>
      </li>
      <li style="color: #96b">
        <label><input type="checkbox" checked value="elective" onclick="updateForce();">
          Upper Div CS Electives
        </label>
      </li>
      <li style="color: #2a2">
        <label><input type="checkbox" checked value="math" onclick="updateForce();">
          Math Courses
        </label>
      </li>
      <li style="color: #f70">
        <label><input type="checkbox" checked value="science" onclick="updateForce();">
          Science Courses
        </label>
      </li>
      <li style="color: #753">
        <label><input type="checkbox" checked value="writing" onclick="updateForce();">
          Writing II (Ethics)
        </label>
      </li>
    </ul>
    <h4>Lines (Requisites):</h4>
    <ul>
      <li>
        <label><input type="checkbox" checked value="Enforced" onclick="updateForce();">
          <span id="solid">Solid</span> - Enforced
        </label>
      </li>
      <li>
        <label><input type="checkbox" checked value="Recommended" onclick="updateForce();">
          <span id="dashed">Dashed</span> - Recommended
        </label>
      </li>
    </ul>
  </div>

  <div id="force">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script>

    var color = {
        "lowerdiv": "#ace",
        "upperdiv": "#17b",
        "math": "#2a2",
        "science": "#f70",
        "elective": "#96b",
        "writing": "#753"
    };

    // width and height for svg element
    var width = Math.max(800, window.innerWidth - 20),
        height = Math.max(500, window.innerHeight - 20);

    // initialize force layout
    var force = d3.layout.force()
        .gravity(0.13)
        .charge(-340)
        .linkDistance(110)
        .size([width, height]);

    // nodes and links for the force layout
    var masterNodes = [],
        masterLinks = [];

    // initialize svg elements
    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height);

    // node and link for svg element
    var node = svg.selectAll(".node"),
        link = svg.selectAll(".link");

    // define line arrow
    svg.append("defs").append("marker")
        .attr("id", "arrowhead")
        .attr("refX", 18)
        .attr("refY", 3)
        .attr("markerWidth", 8)
        .attr("markerHeight", 6)
        .attr("orient", "auto")
        .append("path")
        .attr("d", "M 0,0 V 6 L8,3 Z")
        .attr("fill", "#BBBBBB");

    // update svg element on each force tick
    force.on("tick", function() {
      link.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

      node.attr("transform", function(d) { 
          return "translate(" + d.x + "," + d.y + ")"; });
    });

    // synchronize svg display of nodes and links in force layout
    function updateGraph() {
      link = link.data(force.links(), function(d) { return d.source.name + "-" + d.target.name; });
      link.enter()
        .append("line")
        .attr("class", "link")
        .attr("stroke-dasharray", function(d) {
          if(d.type == "Recommended") return "5,5";
          else return "0,0";
        })
        .attr("marker-end", "url(#arrowhead)");
      link.exit().remove();

      node = node.data(force.nodes(), function(d) { return d.name; });
      var nodeEnter = node.enter()
        .append("g")
        .attr("class", "node")
        .call(force.drag);
      nodeEnter.append("circle")
        .attr("r", 10)
        .style("fill", function(d) { return color[d.type]; });
      nodeEnter.append("text")
        .attr("x", 12)
        .attr("dy", ".35em")
        .text(function(d) {return d.name;} );
      node.exit().remove();

      // bind events to node
      node.on("mouseover", function(d){
          var currentNode = d3.select(this).select("circle");
          var currentColor = d3.rgb(currentNode.style("fill"));

          currentNode
            .attr("r", 11.5)
            .style("fill", currentColor.brighter(0.5));
      }).on("mouseout",  function(d) {
          var currentNode = d3.select(this).select("circle");
          var currentColor = d3.rgb(currentNode.style("fill"));
          currentNode
            .attr("r", 10)
            .style("stroke-width", 0)
            .style("fill", function(d) { return color[d.type]; });
      });
    }

    // update nodes and links in force layout based on checkboxes
    function updateForce() {

      var show = {};
      d3.selectAll('input').each(function(e, i) {
          e = d3.select(this)
          show[e.property('value')] = e.property('checked');
      });
      masterNodes.forEach(function(e) {
        show[e.name] = show[e.type]
      });

      var nodes = masterNodes.filter(function(n) { return show[n.type]; });
      var links = masterLinks.filter(function(n) { return show[n.type] && show[n.source.name] && show[n.target.name]; });

      force
        .nodes(nodes)
        .links(links)
        .start()

      updateGraph();

    }

    // load data
    d3.json("courses.json", function(error, graph) {

      // grab node and relation values from data
      masterNodes = graph.nodes;
      var relations = graph.relations;
      //parse relations into links
      relations.forEach(function(e) { 
          // get source and target index
          var sourceIndex = masterNodes.filter(function(n) { return n.name === e.source; })[0],
              targetIndex = masterNodes.filter(function(n) { return n.name === e.target; })[0];
          // push tuple onto link array
          masterLinks.push({source: sourceIndex, target: targetIndex, type: e.type});
      });

      updateForce()

    });
  </script></div>
</body>
